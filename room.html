<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ito - 部屋</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>ito オンライン - 部屋</h1>

  <div id="roomInfo"></div>
  <div id="playersList"></div>

  <div id="hostControls" style="display:none;">
    <input type="text" id="themeInput" placeholder="テーマを入力" />
    <button onclick="startGame()">ゲームを開始</button>
    <button onclick="resetGame()">ゲームを中断</button>
  </div>

  <div id="playerControls" style="display:none;">
    <h2>あなたの数字: <span id="myNumber"></span></h2>
    <input type="text" id="hintInput" placeholder="ヒントを入力" />
    <button onclick="submitHint()">ヒントを送信</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtoNLxqw_TnTSxdNG7gtb308S0jr5pzpE",
      authDomain: "ito-online-4348a.firebaseapp.com",
      databaseURL: "https://ito-online-4348a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ito-online-4348a",
      storageBucket: "ito-online-4348a.appspot.com",
      messagingSenderId: "840014772869",
      appId: "1:840014772869:web:8230edfc917d7a393a47ec"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');

    let playerName = localStorage.getItem('playerName');
    if (!playerName) {
      playerName = prompt("あなたの名前を入力してください");
      localStorage.setItem('playerName', playerName);
    }

    const roomRef = db.ref("rooms/" + roomId);

    roomRef.child("players/" + playerName).set({
      hint: "",
      number: null
    });

    roomRef.on("value", (snapshot) => {
      const room = snapshot.val();
      if (!room) return;

      document.getElementById("roomInfo").innerText = `部屋コード: ${roomId}`;

      const playersDiv = document.getElementById("playersList");
      playersDiv.innerHTML = "<h2>参加者一覧</h2><ul>" +
        Object.keys(room.players || {}).map(name => `<li>${name}</li>`).join('') + "</ul>";

      if (playerName === room.host) {
        document.getElementById("hostControls").style.display = "block";
        document.getElementById("playerControls").style.display = room.status === "playing" ? "block" : "none";
      } else {
        document.getElementById("hostControls").style.display = "none";
        document.getElementById("playerControls").style.display = room.status === "playing" ? "block" : "none";
      }

      if (room.status === "playing" && room.players[playerName] && room.players[playerName].number !== null) {
        document.getElementById("myNumber").innerText = room.players[playerName].number;
      }
    });

    function startGame() {
      roomRef.once("value", (snapshot) => {
        const room = snapshot.val();
        if (!room) return;

        const playerNames = Object.keys(room.players);
        const numbers = [...Array(playerNames.length)].map((_, i) => i + 1);

        // シャッフル
        for (let i = numbers.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
        }

        const updates = {};
        playerNames.forEach((name, index) => {
          updates[`players/${name}/number`] = numbers[index];
        });
        updates["status"] = "playing";
        updates["theme"] = document.getElementById("themeInput").value || "";

        roomRef.update(updates);
      });
    }

    function resetGame() {
      roomRef.update({
        status: "waiting"
      });

      roomRef.child("players").once("value", (snapshot) => {
        const updates = {};
        snapshot.forEach((child) => {
          updates[child.key + "/number"] = null;
          updates[child.key + "/hint"] = "";
        });
        roomRef.child("players").update(updates);
      });
    }

    function submitHint() {
      const hint = document.getElementById("hintInput").value;
      roomRef.child("players/" + playerName).update({
        hint: hint
      });
    }
  </script>
</body>
</html>
