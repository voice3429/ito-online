<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ito - 部屋</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>ito - 部屋画面</h1>
  <div id="roomInfo"></div>
  <div id="playerList"></div>

  <div id="hostControls" style="display:none;">
    <input type="text" id="themeInput" placeholder="テーマを入力" />
    <button onclick="startGame()">ゲームスタート</button>
    <button onclick="stopGame()">ゲーム中断</button>
  </div>

  <div id="playerControls" style="display:none;">
    <h2 id="yourNumber"></h2>
    <input type="text" id="hintInput" placeholder="ヒントを入力" />
    <button onclick="submitHint()">ヒント送信</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtoNLxqw_TnTSxdNG7gtb308S0jr5pzpE",
      authDomain: "ito-online-4348a.firebaseapp.com",
      databaseURL: "https://ito-online-4348a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ito-online-4348a",
      storageBucket: "ito-online-4348a.appspot.com",
      messagingSenderId: "840014772869",
      appId: "1:840014772869:web:8230edfc917d7a393a47ec"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const params = new URLSearchParams(location.search);
    const roomId = params.get('room');
    let playerName = localStorage.getItem('playerName');

    if (!playerName) {
      playerName = prompt("あなたの名前を入力してください");
      localStorage.setItem('playerName', playerName);
    }

    const roomRef = db.ref("rooms/" + roomId);

    roomRef.once('value').then(snapshot => {
      const roomData = snapshot.val();
      document.getElementById("roomInfo").innerText = `部屋コード: ${roomId}`;

      if (!roomData.players || !roomData.players[playerName]) {
        roomRef.child("players").child(playerName).set({
          hint: "",
          number: null
        });
      }

      // 自分が部屋主かどうか判定
      if (playerName === roomData.host) {
        document.getElementById("hostControls").style.display = "block";
      } else {
        document.getElementById("playerControls").style.display = "block";
      }
    });

    roomRef.child("players").on('value', snapshot => {
      const players = snapshot.val();
      let list = "<h2>参加者</h2><ul>";
      for (const name in players) {
        list += `<li>${name}</li>`;
      }
      list += "</ul>";
      document.getElementById("playerList").innerHTML = list;
    });

    function startGame() {
      const theme = document.getElementById("themeInput").value;
      if (!theme) {
        alert("テーマを入力してください！");
        return;
      }
      roomRef.update({
        status: "playing",
        theme: theme
      });

      roomRef.child("players").once('value').then(snapshot => {
        const players = Object.keys(snapshot.val());
        const numbers = shuffle([...Array(players.length)].map((_, i) => i + 1));
        players.forEach((name, idx) => {
          roomRef.child("players").child(name).update({
            number: numbers[idx]
          });
        });
      });
    }

    function stopGame() {
      roomRef.update({
        status: "waiting",
        theme: ""
      });
      roomRef.child("players").once('value').then(snapshot => {
        const updates = {};
        snapshot.forEach(child => {
          updates[child.key + "/number"] = null;
          updates[child.key + "/hint"] = "";
        });
        roomRef.child("players").update(updates);
      });
    }

    function submitHint() {
      const hint = document.getElementById("hintInput").value;
      if (!hint) {
        alert("ヒントを入力してください！");
        return;
      }
      roomRef.child("players").child(playerName).update({
        hint: hint
      });
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  </script>
</body>
</html>
