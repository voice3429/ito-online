<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ito - 部屋</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>ito オンライン - 部屋</h1>
  <div id="room-info"></div>
  <div id="controls"></div>
  <div id="player-area"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtoNLxqw_TnTSxdNG7gtb308S0jr5pzpE",
      authDomain: "ito-online-4348a.firebaseapp.com",
      databaseURL: "https://ito-online-4348a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ito-online-4348a",
      storageBucket: "ito-online-4348a.appspot.com",
      messagingSenderId: "840014772869",
      appId: "1:840014772869:web:8230edfc917d7a393a47ec"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    let playerName = urlParams.get('name');

    if (!playerName) {
      playerName = prompt("あなたの名前を入力してください");
      if (!playerName) {
        alert("名前が必要です");
        window.location.href = "/";
      }
      db.ref(`rooms/${roomId}/players/${playerName}`).set({
        hint: "",
        number: null,
        ready: false
      });
    }

    const roomRef = db.ref(`rooms/${roomId}`);

    roomRef.on("value", snapshot => {
      const roomData = snapshot.val();
      if (!roomData) return;

      document.getElementById("room-info").innerText = `部屋ID: ${roomId}`;

      const isHost = (playerName === roomData.host);
      const controls = document.getElementById("controls");
      controls.innerHTML = "";

      if (roomData.status === "waiting") {
        if (isHost) {
          controls.innerHTML = `
            <input type="text" id="theme" placeholder="テーマを入力">
            <button onclick="startGame()">ゲーム開始</button>
          `;
        } else {
          controls.innerText = "部屋主がゲームを開始するのを待っています...";
        }
      } else if (roomData.status === "playing") {
        if (roomData.players[playerName].number !== null) {
          controls.innerHTML = `あなたの数字: ${roomData.players[playerName].number}<br>
          <input type="text" id="hint" placeholder="ヒントを入力">
          <button onclick="submitHint()">ヒント提出</button>`;
        }
        if (isHost) {
          controls.innerHTML += `<br><button onclick="cancelGame()">ゲーム中断</button>`;
        }
      } else if (roomData.status === "revealing") {
        let hints = "ヒント一覧:<br>";
        for (const [name, player] of Object.entries(roomData.players)) {
          hints += `${name}: ${player.hint}<br>`;
        }
        controls.innerHTML = hints;
      }
    });

    function startGame() {
      const theme = document.getElementById("theme").value;
      if (!theme) {
        alert("テーマを入力してください");
        return;
      }

      const numbers = shuffle([...Array(100).keys()].map(x => x + 1));
      roomRef.once("value").then(snapshot => {
        const players = snapshot.val().players;
        let updates = {};
        let i = 0;
        for (const name in players) {
          updates[`players/${name}/number`] = numbers[i++];
        }
        updates['status'] = "playing";
        updates['theme'] = theme;
        roomRef.update(updates);
      });
    }

    function submitHint() {
      const hint = document.getElementById("hint").value;
      if (!hint) {
        alert("ヒントを入力してください");
        return;
      }
      db.ref(`rooms/${roomId}/players/${playerName}`).update({
        hint: hint,
        ready: true
      });

      roomRef.once("value").then(snapshot => {
        const players = snapshot.val().players;
        const allReady = Object.values(players).every(p => p.hint);
        if (allReady && playerName === snapshot.val().host) {
          roomRef.update({status: "revealing"});
        }
      });
    }

    function cancelGame() {
      roomRef.update({status: "waiting"});
      for (const name in roomRef.players) {
        roomRef.child(`players/${name}`).update({
          number: null,
          hint: "",
          ready: false
        });
      }
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  </script>
</body>
</html>
