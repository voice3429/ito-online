
=== room.html ===
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ito - 部屋</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>ito オンライン - 部屋</h1>
  <div id="roomInfo"></div>
  <div id="players"></div>
  <div id="game"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtoNLxqw_TnTSxdNG7gtb308S0jr5pzpE",
      authDomain: "ito-online-4348a.firebaseapp.com",
      databaseURL: "https://ito-online-4348a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ito-online-4348a",
      storageBucket: "ito-online-4348a.appspot.com",
      messagingSenderId: "840014772869",
      appId: "1:840014772869:web:8230edfc917d7a393a47ec"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');

    let playerName = localStorage.getItem('playerName') || prompt("名前を入力してください");
    if (!playerName) playerName = "ゲスト" + Math.floor(Math.random() * 1000);
    localStorage.setItem('playerName', playerName);

    const isHost = localStorage.getItem('isHost') === 'true';

    db.ref(`rooms/${roomId}/players/${playerName}`).set({
      hint: "",
      number: null
    });

    db.ref(`rooms/${roomId}/players`).on('value', (snapshot) => {
      const playersData = snapshot.val();
      const playersDiv = document.getElementById('players');
      playersDiv.innerHTML = '<h3>参加者一覧</h3>';
      for (let name in playersData) {
        playersDiv.innerHTML += `<div>${name}</div>`;
      }
    });

    if (isHost) {
      const gameDiv = document.getElementById('game');
      gameDiv.innerHTML = `
        <input type="text" id="themeInput" placeholder="テーマを入力">
        <button onclick="startGame()">ゲームスタート</button>
        <button onclick="cancelGame()">ゲーム中断</button>
      `;
    }

    function startGame() {
      const theme = document.getElementById('themeInput').value;
      if (!theme) {
        alert('テーマを入力してください');
        return;
      }

      db.ref(`rooms/${roomId}/theme`).set(theme);

      db.ref(`rooms/${roomId}/players`).once('value', (snapshot) => {
        const players = snapshot.val();
        const numbers = shuffle(Array.from({length: Object.keys(players).length}, (_, i) => i + 1));
        let updates = {};
        let i = 0;
        for (let name in players) {
          updates[name + '/number'] = numbers[i];
          i++;
        }
        db.ref(`rooms/${roomId}/players`).update(updates);
        db.ref(`rooms/${roomId}/status`).set('playing');
      });
    }

    function cancelGame() {
      db.ref(`rooms/${roomId}/status`).set('waiting');
      db.ref(`rooms/${roomId}/players`).once('value', (snapshot) => {
        const players = snapshot.val();
        let updates = {};
        for (let name in players) {
          updates[name + '/number'] = null;
        }
        db.ref(`rooms/${roomId}/players`).update(updates);
      });
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    db.ref(`rooms/${roomId}/status`).on('value', (snapshot) => {
      const status = snapshot.val();
      const gameDiv = document.getElementById('game');
      if (status === 'playing') {
        db.ref(`rooms/${roomId}/players/${playerName}/number`).once('value', (snap) => {
          const number = snap.val();
          gameDiv.innerHTML = `<h3>あなたの数字：${number}</h3><input type='text' placeholder='ヒントを入力'>`;
        });
      } else {
        if (!isHost) {
          gameDiv.innerHTML = '<h3>待機中...</h3>';
        }
      }
    });
  </script>
</body>
</html>
