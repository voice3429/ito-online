<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ito Online</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px; padding: 5px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>ito オンライン</h1>

  <!-- 部屋作成画面 -->
  <div id="createRoom">
    <button onclick="createRoom()">部屋を作る</button>
  </div>

  <!-- 参加画面 -->
  <div id="joinArea" class="hidden">
    <h3>部屋: <span id="roomIdDisplay"></span></h3>
    <input id="nameInput" placeholder="名前">
    <button onclick="joinRoom()">参加</button>
  </div>

  <!-- ゲームマスター画面 -->
  <div id="hostControls" class="hidden">
    <h3>ゲームマスター設定</h3>
    <input id="themeInput" placeholder="テーマ">
    <button onclick="setTheme()">テーマ決定</button>
    <button onclick="startGame()">ゲーム開始</button>
  </div>

  <!-- 参加者リスト -->
  <h2>参加者</h2>
  <ul id="playerList"></ul>

  <!-- ゲーム開始後画面 -->
  <div id="gameArea" class="hidden">
    <h2>テーマ: <span id="themeDisplay"></span></h2>
    <div id="yourNumber"></div>
    <input id="hintInput" placeholder="ヒント">
    <button onclick="sendHint()">ヒント送信</button>
    <h3>ヒント一覧</h3>
    <div id="hintList"></div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBtoNLxqw_TnTSxdNG7gtb308S0jr5pzpE",
    authDomain: "ito-online-4348a.firebaseapp.com",
    databaseURL: "https://ito-online-4348a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ito-online-4348a",
    storageBucket: "ito-online-4348a.appspot.com",
    messagingSenderId: "840014772869",
    appId: "1:840014772869:web:8230edfc917d7a393a47ec"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const urlParams = new URLSearchParams(window.location.search);
  let roomId = urlParams.get('room');
  let playerName = '';
  let isHost = false;

  if (roomId) {
    document.getElementById('createRoom').classList.add('hidden');
    document.getElementById('joinArea').classList.remove('hidden');
    document.getElementById('roomIdDisplay').textContent = roomId;
    watchPlayers();
  }

  function createRoom() {
    const newRoom = db.ref('rooms').push();
    roomId = newRoom.key;
    isHost = true;
    window.location.href = window.location.pathname + '?room=' + roomId;
  }

  function joinRoom() {
    playerName = document.getElementById('nameInput').value;
    const number = Math.floor(Math.random() * 100) + 1;
    db.ref(`rooms/${roomId}/players/${playerName}`).set({ number, hint: '' });
    if (isHost) {
      document.getElementById('hostControls').classList.remove('hidden');
    }
    document.getElementById('joinArea').classList.add('hidden');
  }

  function setTheme() {
    const theme = document.getElementById('themeInput').value;
    db.ref(`rooms/${roomId}/theme`).set(theme);
  }

  function startGame() {
    db.ref(`rooms/${roomId}/started`).set(true);
  }

  function sendHint() {
    const hint = document.getElementById('hintInput').value;
    db.ref(`rooms/${roomId}/players/${playerName}/hint`).set(hint);
  }

  function watchPlayers() {
    db.ref(`rooms/${roomId}/players`).on('value', snapshot => {
      const players = snapshot.val() || {};
      const list = document.getElementById('playerList');
      list.innerHTML = '';
      for (let name in players) {
        const li = document.createElement('li');
        li.textContent = name;
        list.appendChild(li);
      }
    });

    db.ref(`rooms/${roomId}/theme`).on('value', snapshot => {
      document.getElementById('themeDisplay').textContent = snapshot.val() || '';
    });

    db.ref(`rooms/${roomId}/started`).on('value', snapshot => {
      if (snapshot.val()) {
        document.getElementById('gameArea').classList.remove('hidden');
        db.ref(`rooms/${roomId}/players/${playerName}/number`).once('value').then(numSnap => {
          document.getElementById('yourNumber').textContent = `あなたの数字は「${numSnap.val()}」です`;
        });
      }
    });

    db.ref(`rooms/${roomId}/players`).on('value', snapshot => {
      const players = snapshot.val() || {};
      const hintList = document.getElementById('hintList');
      hintList.innerHTML = '';
      for (let name in players) {
        const hint = players[name].hint || '（未入力）';
        hintList.innerHTML += `<div><strong>${name}:</strong> ${hint}</div>`;
      }
    });
  }
</script>
</body>
</html>
