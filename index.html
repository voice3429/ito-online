
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ito Online</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px; padding: 5px; }
    .hint { margin: 5px 0; border-bottom: 1px solid #ccc; }
    .secret { color: gray; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>ito オンライン</h1>
  <div id="main"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtoNLxqw_TnTSxdNG7gtb308S0jr5pzpE",
      authDomain: "ito-online-4348a.firebaseapp.com",
      databaseURL: "https://ito-online-4348a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ito-online-4348a",
      storageBucket: "ito-online-4348a.appspot.com",
      messagingSenderId: "840014772869",
      appId: "1:840014772869:web:8230edfc917d7a393a47ec"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const params = new URLSearchParams(window.location.search);
    const roomCode = params.get("room");

    if (!roomCode) {
      // ホスト画面：部屋作成
      const room = Math.random().toString(36).substring(2, 8);
      db.ref("rooms/" + room).set({ theme: "", started: false });
      const div = document.getElementById("main");
      div.innerHTML = \`
        <p>部屋を作成しました： <strong>\${room}</strong></p>
        <p>以下のURLを参加者に送ってください：</p>
        <p><a href="?room=\${room}">\${location.href}?room=\${room}</a></p>
        <input id="hostName" placeholder="あなたの名前（主催者）">
        <button onclick="registerHost('\${room}')">参加</button>
        <div id="hostPanel" style="display:none;">
          <input id="themeInput" placeholder="テーマ入力">
          <button onclick="setTheme('\${room}')">テーマ決定</button>
          <button onclick="startGame('\${room}')">ゲーム開始</button>
        </div>
        <div id="themeDisplay"></div>
        <h3>ヒント一覧</h3>
        <div id="hintList"></div>
      \`;
    } else {
      // 参加者画面
      const div = document.getElementById("main");
      div.innerHTML = \`
        <p>部屋コード：<strong>\${roomCode}</strong></p>
        <input id="nameInput" placeholder="名前を入力">
        <button onclick="joinRoom('\${roomCode}')">参加</button>
        <div id="playerPanel" style="display:none;">
          <div id="yourNumber" class="secret"></div>
          <input id="hintInput" placeholder="ヒントを入力">
          <button onclick="sendHint('\${roomCode}')">ヒント送信</button>
        </div>
        <h3>テーマ</h3>
        <div id="themeDisplay"></div>
        <h3>ヒント一覧</h3>
        <div id="hintList"></div>
      \`;
    }

    let playerName = "";

    function registerHost(room) {
      playerName = document.getElementById("hostName").value;
      db.ref("rooms/" + room + "/players/" + playerName).set({ hint: "", number: 0 });
      document.getElementById("hostPanel").style.display = "block";
    }

    function setTheme(room) {
      const theme = document.getElementById("themeInput").value;
      db.ref("rooms/" + room + "/theme").set(theme);
    }

    function startGame(room) {
      db.ref("rooms/" + room + "/players").once("value", snapshot => {
        const players = snapshot.val();
        const names = Object.keys(players);
        const nums = names.map((_, i) => i + 1).sort(() => Math.random() - 0.5);
        names.forEach((name, i) => {
          db.ref("rooms/" + room + "/players/" + name + "/number").set(nums[i]);
        });
        db.ref("rooms/" + room + "/started").set(true);
      });
    }

    function joinRoom(room) {
      playerName = document.getElementById("nameInput").value;
      db.ref("rooms/" + room + "/players/" + playerName).set({ hint: "", number: 0 });
      document.getElementById("playerPanel").style.display = "block";
    }

    function sendHint(room) {
      const hint = document.getElementById("hintInput").value;
      db.ref("rooms/" + room + "/players/" + playerName + "/hint").set(hint);
    }

    function update(room) {
      db.ref("rooms/" + room + "/theme").on("value", snap => {
        document.getElementById("themeDisplay").textContent = snap.val() || "未設定";
      });
      db.ref("rooms/" + room + "/players").on("value", snap => {
        const data = snap.val();
        const list = document.getElementById("hintList");
        list.innerHTML = "";
        for (let name in data) {
          const hint = data[name].hint || "（未入力）";
          list.innerHTML += \`<div class="hint"><strong>\${name}</strong>: \${hint}</div>\`;
        }
        if (data[playerName] && data[playerName].number > 0) {
          const n = data[playerName].number;
          const target = document.getElementById("yourNumber");
          if (target) target.textContent = \`あなたの数字：\${n}\`;
        }
      });
    }

    if (roomCode) update(roomCode);
  </script>
</body>
</html>
