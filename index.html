<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ito オンライン</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px; padding: 8px; }
    .hidden { display: none; }
    .player { margin: 4px 0; }
  </style>
</head>
<body>
  <h1>ito オンライン</h1>

  <!-- 部屋作成エリア（初期表示） -->
  <div id="roomCreator">
    <button onclick="createRoom()">部屋を作る</button>
    <div id="roomUrl"></div>
  </div>

  <!-- 名前入力エリア（部屋参加用） -->
  <div id="joinRoom" class="hidden">
    <h3>部屋コード: <span id="roomIdDisplay"></span></h3>
    <p>名前を入力して参加してください</p>
    <input id="playerNameInput" placeholder="あなたの名前">
    <button onclick="joinRoom()">参加</button>
  </div>

  <!-- ゲームエリア（参加後） -->
  <div id="gameArea" class="hidden">
    <h2>参加者一覧（部屋コード: <span id="roomCodeDisplay"></span>）</h2>
    <div id="playerList"></div>
    
    <!-- ホスト専用エリア（部屋作成者のみ表示） -->
    <div id="hostArea" class="hidden">
      <h3>ゲームマスターのコントロール</h3>
      <p>テーマ設定と「ゲーム開始」ボタンはこちら</p>
      <input id="themeInput" placeholder="例: 大きさ、知名度など">
      <button onclick="setTheme()">テーマ決定</button>
      <button onclick="startGame()">🎲 ゲーム開始</button>
    </div>

    <h3>現在のテーマ</h3>
    <div id="currentTheme">（まだ未設定）</div>
  </div>

  <script>
    // Firebase接続設定（必要情報に書き換え済み）
    const firebaseConfig = {
      apiKey: "AIzaSyBtoNLxqw_TnTSxdNG7gtb308S0jr5pzpE",
      authDomain: "ito-online-4348a.firebaseapp.com",
      databaseURL: "https://ito-online-4348a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ito-online-4348a",
      storageBucket: "ito-online-4348a.appspot.com",
      messagingSenderId: "840014772869",
      appId: "1:840014772869:web:8230edfc917d7a393a47ec"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId = "";
    let isHost = false;
    let playerName = "";

    // URLクエリからroomパラメータを取得（すでに部屋が作成されている場合）
    const params = new URLSearchParams(window.location.search);
    if (params.has("room")) {
      roomId = params.get("room");
      document.getElementById("roomCreator").classList.add("hidden");
      document.getElementById("joinRoom").classList.remove("hidden");
      document.getElementById("roomIdDisplay").textContent = roomId;
    }

    // 部屋作成（ゲームマスター用）
    function createRoom() {
      roomId = Math.random().toString(36).substr(2, 6);
      isHost = true;
      const newUrl = `${location.origin}${location.pathname}?room=${roomId}`;
      document.getElementById("roomUrl").innerHTML =
        `部屋が作成されました！<br>このURLを共有してください：<br><a href="${newUrl}" target="_blank">${newUrl}</a>`;
      document.getElementById("roomCreator").classList.add("hidden");
      document.getElementById("joinRoom").classList.remove("hidden");
      document.getElementById("roomIdDisplay").textContent = roomId;
    }

    // 部屋参加処理
    function joinRoom() {
      playerName = document.getElementById("playerNameInput").value;
      if (!playerName) { alert("名前を入力してください！"); return; }
      db.ref(`rooms/${roomId}/players/${playerName}`).set({ joined: true });
      document.getElementById("joinRoom").classList.add("hidden");
      document.getElementById("gameArea").classList.remove("hidden");
      document.getElementById("roomCodeDisplay").textContent = roomId;
      // ゲームマスターならホストエリアを表示
      if (isHost) {
        document.getElementById("hostArea").classList.remove("hidden");
      }
      watchPlayers();
      watchTheme();
    }

    // リアルタイム参加者一覧監視
    function watchPlayers() {
      db.ref(`rooms/${roomId}/players`).on("value", snapshot => {
        const players = snapshot.val() || {};
        let html = "";
        for (let name in players) {
          html += `<div class="player">${name}</div>`;
        }
        document.getElementById("playerList").innerHTML = html;
      });
    }

    // テーマ設定・表示処理
    function setTheme() {
      const theme = document.getElementById("themeInput").value;
      db.ref(`rooms/${roomId}/theme`).set(theme);
    }

    function watchTheme() {
      db.ref(`rooms/${roomId}/theme`).on("value", snapshot => {
        document.getElementById("currentTheme").textContent = snapshot.val() || "（まだ未設定）";
      });
    }

    // ゲーム開始処理（ここに任意の処理を追加できます）
    function startGame() {
      db.ref(`rooms/${roomId}/status`).set("started");
      alert("ゲームが開始されました！");
    }
  </script>
</body>
</html>
